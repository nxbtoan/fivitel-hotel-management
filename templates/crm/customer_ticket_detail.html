{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Chi tiết Yêu cầu #{{ ticket.id }} - Fivitel{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/crm.css' %}">
{% endblock %}

{% block content %}
<div class="crm-customer-page">
    <div class="page-banner">
        <h1 class="page-title">{{ ticket.subject|default:"Chi tiết Yêu cầu" }}</h1>
        <p class="page-subtitle">Mã Yêu cầu: #{{ ticket.ticket_id|truncatechars:8 }}...</p>
    </div>

    <div class="container" style="padding-top: 60px;">
        <div class="ticket-detail-grid">
            <main class="chat-container">
                <div class="response-history">
                    {% for response in responses %}
                        <div class="response-item {% if response.responder == user %}my-response{% else %}staff-response{% endif %}">
                            <span class="responder-name">{{ response.responder.full_name|default:response.responder.username }}</span>
                            <p>{{ response.message|linebreaksbr }}</p>
                            <span class="timestamp">{{ response.created_at|naturaltime }}</span>
                        </div>
                    {% empty %}
                        <p style="text-align: center; color: #888;">Chưa có phản hồi nào trong hội thoại này.</p>
                    {% endfor %}
                </div>
                
                {% if ticket.status != 'RESOLVED' %}
                <div class="reply-form">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="{{ reply_form.message.id_for_label }}">Gửi trả lời mới:</label>
                            
                            {{ reply_form.message }}
                            {{ reply_form.message.errors }}
                        </div>
                        
                        <button type="submit" name="submit_reply" class="btn-primary" style="margin-top: 10px;">Gửi trả lời</button>
                    </form>
                </div>
                {% endif %}
                </main>

            <aside class="ticket-detail-sidebar">
                <div class="my-tickets-list">
                    <div class="detail-card">
                        <h3>Thông tin Yêu cầu</h3>
                        <div class="info-grid">
                            <div class="info-item"><strong>Trạng thái:</strong><span><span class="status-badge status-{{ ticket.status }}">{{ ticket.get_status_display }}</span></span></div>
                            <div class="info-item"><strong>Loại yêu cầu:</strong><span>{{ ticket.get_type_display }}</span></div>
                            {% if ticket.type == 'COMPLAINT' and ticket.complaint_type %}
                                <div class="info-item"><strong>Phân loại:</strong><span>{{ ticket.get_complaint_type_display }}</span></div>
                            {% endif %}
                            {% if ticket.incident_time %}
                                <div class="info-item"><strong>Thời gian vụ việc:</strong><span>{{ ticket.incident_time|date:"d/m/Y H:i" }}</span></div>
                            {% endif %}
                            {% if ticket.attachment %}
                                <div class="info-item"><strong>Tệp đính kèm:</strong><span><a href="{{ ticket.attachment.url }}" target="_blank">Xem tệp</a></span></div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="detail-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                        <h3 style="margin: 0; padding: 0; border: none;">Nội dung gốc</h3>
                        {% if can_edit %}
                        <button type="button" id="toggle-edit-btn" class="toggle-edit-btn">
                            <i class="fas fa-pencil-alt"></i> Sửa
                        </button>
                        {% endif %}
                    </div>

                    <div id="original-description">
                        <p style="white-space: pre-wrap; color: #333;">{{ ticket.description|linebreaks }}</p>
                    </div>

                    {% if can_edit %}
                    <form id="edit-form" method="post" novalidate class="edit-ticket-form" style="display: none;">
                        {% csrf_token %}
                        <div class="form-title">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 24px; height: 24px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M16.862 3.487l3.651 3.65m-2.29-1.36L6.112 17.887a4.5 4.5 0 01-1.767 1.06l-2.086.6.6-2.086a4.5 4.5 0 011.06-1.767L16.223 3.776z"/>
                            </svg>
                            Chỉnh sửa yêu cầu (còn 1 giờ)
                        </div>
                        <div class="form-group">
                            {{ edit_form.description.label_tag }}
                            {{ edit_form.description }} {# CSS sẽ tự thêm class form-control nếu cấu hình form #}
                            {{ edit_form.description.errors }}
                        </div>
                        <div class="edit-actions">
                            <button type="submit" name="submit_edit" class="btn-primary btn-save-edit">Lưu thay đổi</button>
                            <button type="button" id="cancel-edit-btn" class="btn-secondary btn-cancel-edit">Hủy</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
            </aside>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const toggleBtn = document.getElementById("toggle-edit-btn");
    const editForm = document.getElementById("edit-form");
    const cancelBtn = document.getElementById("cancel-edit-btn");
    const originalDesc = document.getElementById("original-description");

    if (toggleBtn && editForm && originalDesc) {
        toggleBtn.addEventListener("click", () => {
            editForm.style.display = "block";
            originalDesc.style.display = "none";
            toggleBtn.style.display = "none";
        });
    }

    if (cancelBtn && editForm && toggleBtn && originalDesc) {
        cancelBtn.addEventListener("click", () => {
            editForm.style.display = "none";
            originalDesc.style.display = "block";
            toggleBtn.style.display = "inline-block";
        });
    }
});
</script>
{% endblock %}