{% extends 'dashboard_base.html' %}
{% load booking_extras %}

{% block dashboard_title %}{% if is_new %}Tạo mới{% else %}Chỉnh sửa{% endif %} Dịch vụ{% endblock %}
{% block header_title %}{% if is_new %}Tạo mới{% else %}Chỉnh sửa{% endif %} Dịch vụ{% endblock %}

{% block header_back_link %}
    <a href="{% url 'service_list' %}" class="header-back-link">
        <i class="fas fa-chevron-left"></i> Quay lại Danh sách
    </a>
{% endblock %}

{% block dashboard_content %}
<div class="service-management-page">
    <div class="form-container">
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <h2 class="form-section-title">Thông tin Dịch vụ Chính</h2>
            
            {% if form.non_field_errors %}
                <div class="form-errors">{{ form.non_field_errors }}</div>
            {% endif %}

            <div class="form-grid-2-col">
                <div class="form-field">
                    {{ form.category.label_tag }}
                    {{ form.category|add_attr:"class:form-control" }}
                    {% if form.category.errors %}<div class="form-error-text">{{ form.category.errors }}</div>{% endif %}
                </div>
                <div class="form-field">
                    {{ form.name.label_tag }}
                    {{ form.name|add_attr:"class:form-control" }}
                    {% if form.name.errors %}<div class="form-error-text">{{ form.name.errors }}</div>{% endif %}
                </div>
                
                <div class="form-field">
                    {{ form.price.label_tag }}
                    {{ form.price|add_attr:"class:form-control" }}
                    {% if form.price.errors %}<div class="form-error-text">{{ form.price.errors }}</div>{% endif %}
                </div>
                <div class="form-field">
                    {{ form.price_unit.label_tag }}
                    {{ form.price_unit|add_attr:"class:form-control" }}
                    {% if form.price_unit.errors %}<div class="form-error-text">{{ form.price_unit.errors }}</div>{% endif %}
                </div>

                <div class="form-field">
                    {{ form.status.label_tag }}
                    {{ form.status|add_attr:"class:form-control" }}
                    {% if form.status.errors %}<div class="form-error-text">{{ form.status.errors }}</div>{% endif %}
                </div>
                
                <div class="form-field">
                    {{ form.image.label_tag }}
                    {% if service.image %}
                        <p class="current-image-text">Ảnh hiện tại: <a href="{{ service.image.url }}" target="_blank">{{ service.image.name|truncatechars:30 }}</a></p>
                    {% endif %}
                    {{ form.image|add_attr:"class:form-control-file" }}
                    {% if form.image.errors %}<div class="form-error-text">{{ form.image.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="form-field full-width">
                {{ form.description.label_tag }}
                {{ form.description|add_attr:"class:form-control" }}
                {% if form.description.errors %}<div class="form-error-text">{{ form.description.errors }}</div>{% endif %}
            </div>
            <div class="form-field full-width">
                {{ form.highlights.label_tag }} (Mỗi mục một dòng)
                {{ form.highlights|add_attr:"class:form-control" }}
                {% if form.highlights.errors %}<div class="form-error-text">{{ form.highlights.errors }}</div>{% endif %}
            </div>
            <div class="form-field full-width">
                {{ form.terms_conditions.label_tag }} (Mỗi mục một dòng)
                {{ form.terms_conditions|add_attr:"class:form-control" }}
                {% if form.terms_conditions.errors %}<div class="form-error-text">{{ form.terms_conditions.errors }}</div>{% endif %}
            </div>

            <hr class="form-divider">

            <h2 class="form-section-title">Thư viện ảnh (Gallery)</h2>
            
            {{ formset.management_form }}
            
            {% if formset.non_field_errors %}
                <div class="form-errors">{{ formset.non_field_errors }}</div>
            {% endif %}
            
            <div class="gallery-formset">
                {% for image_form in formset %}
                <div class="gallery-form-item">
                    {{ image_form.id }}
                    <div class="form-field">
                        {{ image_form.image.label_tag }}
                        {% if image_form.instance.pk and image_form.instance.image %}
                             <p class="current-image-text">Ảnh hiện tại: <a href="{{ image_form.instance.image.url }}" target="_blank">{{ image_form.instance.image.name|truncatechars:30 }}</a></p>
                        {% endif %}
                        {{ image_form.image|add_attr:"class:form-control-file" }}
                        {% if image_form.image.errors %}<div class="form-error-text">{{ image_form.image.errors }}</div>{% endif %}
                    </div>
                    
                    <div class="form-field">
                        {{ image_form.alt_text.label_tag }}
                        {{ image_form.alt_text|add_attr:"class:form-control" }}
                        {% if image_form.alt_text.errors %}<div class="form-error-text">{{ image_form.alt_text.errors }}</div>{% endif %}
                    </div>
                    
                    {% if image_form.instance.pk %}
                    <div class="form-field-checkbox">
                        {{ image_form.DELETE.label_tag }}
                        {{ image_form.DELETE }}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <button type="submit" class="btn-book" style="margin-top: 20px;">Lưu Dịch vụ</button>
        </form>
    </div>
</div>
{% endblock %}