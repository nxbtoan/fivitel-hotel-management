{% extends 'base.html' %}
{% load static %}

{% block title %}Đổi Mật Khẩu{% endblock %}

{% block styles %}
    {# Liên kết đến file CSS đã có của bạn #}
    <link rel="stylesheet" href="{% static 'css/users.css' %}">
{% endblock %}

{% block content %}
<div class="user-profile-page">
    <div class="user-form-container">
        
        <h2 class="page-title">Đổi Mật Khẩu</h2>
        <p class="page-subtitle">Để bảo mật, vui lòng nhập mật khẩu cũ và mật khẩu mới của bạn.</p>

        <form method="post" novalidate>
            {% csrf_token %}

            {# Hiển thị lỗi chung (ví dụ: 2 mật khẩu mới không khớp) #}
            {% if form.non_field_errors %}
                <div class="alert alert-danger" role="alert" style="background-color: #f8d7da; border-color: #f5c2c7; color: #721c24;">
                    {% for error in form.non_field_errors %}
                        {{ error }}
                    {% endfor %}
                </div>
            {% endif %}

            {# Hiển thị lỗi cụ thể của từng trường nếu cần #}
            {% if form.errors and not form.non_field_errors %}
                <div class="alert alert-danger" role="alert" style="background-color: #f8d7da; border-color: #f5c2c7; color: #721c24;">
                    Vui lòng kiểm tra lại thông tin bạn đã nhập.
                </div>
            {% endif %}

            <div class="form-group">
                <label for="{{ form.old_password.auto_id }}">Mật khẩu cũ</label>
                <div class="password-wrapper">
                    {{ form.old_password }}
                    <i class="fas fa-eye toggle-password-icon" id="toggle-old-password"></i>
                </div>
                {% if form.old_password.errors %}
                    <ul class="errorlist">
                        {% for error in form.old_password.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.new_password1.auto_id }}">Mật khẩu mới</label>
                <div class="password-wrapper">
                    {{ form.new_password1 }}
                    <i class="fas fa-eye toggle-password-icon" id="toggle-new-password-1"></i>
                </div>
                {% if form.new_password1.errors %}
                    <ul class="errorlist">
                        {% for error in form.new_password1.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div class="form-group">
                <label for="{{ form.new_password2.auto_id }}">Xác nhận mật khẩu mới</label>
                <div class="password-wrapper">
                    {{ form.new_password2 }}
                    <i class="fas fa-eye toggle-password-icon" id="toggle-new-password-2"></i>
                </div>
                {% if form.new_password2.errors %}
                    <ul class="errorlist">
                        {% for error in form.new_password2.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
            
            <button type="submit" class="submit-button">Lưu Thay Đổi</button>
        </form>
        
        <div class="password-change-link">
            <a href="{% url 'profile_update' %}" class="btn-outline-secondary">Quay lại trang cá nhân</a>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    /**
     * Hàm trợ giúp: 
     * Gắn logic Ẩn/Hiện cho một cặp (icon và input).
     * Cũng tự động thêm class 'form-control' vào input.
     */
    function setupPasswordToggle(toggleIconId, inputId) {
        const toggleIcon = document.getElementById(toggleIconId);
        const input = document.getElementById(inputId);

        // Kiểm tra xem cả hai element có tồn tại không
        if (toggleIcon && input) {
            
            // 1. Thêm class 'form-control' (logic cũ của bạn)
            input.classList.add("form-control");

            // 2. Gắn sự kiện click cho icon
            toggleIcon.addEventListener("click", function() {
                // Lấy trạng thái type hiện tại của input
                const type = input.getAttribute("type") === "password" ? "text" : "password";
                input.setAttribute("type", type);
                
                // Đổi icon: fa-eye (hiện) <-> fa-eye-slash (ẩn)
                this.classList.toggle("fa-eye");
                this.classList.toggle("fa-eye-slash");
            });
        }
    }

    // Áp dụng hàm trợ giúp cho cả 3 trường mật khẩu
    setupPasswordToggle("toggle-old-password", "{{ form.old_password.auto_id }}");
    setupPasswordToggle("toggle-new-password-1", "{{ form.new_password1.auto_id }}");
    setupPasswordToggle("toggle-new-password-2", "{{ form.new_password2.auto_id }}");

});
</script>
{% endblock %}