{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Hoàn tất Đặt phòng - Fivitel{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/booking.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="booking-flow-page">
        <main class="main-content">
            <form id="checkoutForm" method="post" novalidate
                  data-is-authenticated="{{ user.is_authenticated|yesno:'true,false' }}"
                  data-full-name="{{ user.full_name|default:'' }}"
                  data-email="{{ user.email|default:'' }}"
                  data-phone="{{ user.phone_number|default:'' }}"
                  data-nationality="{{ user.nationality.code|default:'' }}">
                {% csrf_token %}
                
                <section class="booking-section">
                    <h3>1. Thông tin khách hàng</h3>
                    {% if user.is_authenticated %}
                    <div class="segmented-control-wrapper">
                        <span>Tôi đang đặt cho</span>
                        <div class="segmented-control">
                            {% for radio in form.booking_for %}
                            {{ radio.tag }}
                            <label for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <p style="font-size: 0.9em; color: #555;">Nhập thông tin của khách ở chính.</p>
                    
                    <div id="guest-details" class="form-grid" style="margin-top: 20px;">
                        <div class="form-field full-width">{{ form.full_name.label_tag }} {{ form.full_name }}</div>
                        <div class="form-field">{{ form.email.label_tag }} {{ form.email }}</div>
                        <div class="form-field">{{ form.phone_number.label_tag }} {{ form.phone_number }}</div>
                        <div class="form-field full-width">{{ form.nationality.label_tag }} {{ form.nationality }}</div>
                    </div>
                </section>

                <section class="booking-section">
                    <h3>2. Yêu cầu đặc biệt (nếu có)</h3>
                    <div class="form-field">{{ form.special_requests.label_tag }} {{ form.special_requests }}</div>
                </section>

                <section class="booking-section">
                    <h3>3. Chọn phương thức thanh toán</h3>
                    <div class="payment-options">
                        {% for choice in form.payment_method %}
                        <label class="payment-option-card" for="{{ choice.id_for_label }}">
                            <div class="payment-wrapper">
                                {{ choice.tag }}
                                <div class="payment-info">
                                    <strong>{{ choice.choice_label }}</strong>
                                    {% if choice.data.value == 'PAY_LATER' %}
                                    <p>Thanh toán toàn bộ chi phí trực tiếp tại quầy lễ tân khi bạn nhận phòng.</p>
                                    {% elif choice.data.value == 'BANK_TRANSFER' %}
                                    <p>Chuyển khoản trực tiếp. Lễ tân sẽ liên hệ với bạn để hướng dẫn chi tiết.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </section>
            </form>
        </main>

        <aside class="summary-sidebar">
            <h3>Tóm tắt đơn hàng</h3>
            <div class="summary-details">
                <div class="summary-item">
                    <span style="font-weight: 600; color: var(--primary-blue);">{{ room_class.name }}</span>
                </div>
                <div class="summary-item">
                    <span>Thời gian ở</span>
                    <span>{{ duration }} đêm</span>
                </div>
                <div class="summary-item">
                    <span>Tiền phòng</span>
                    <span>{{ room_price|intcomma }} đ</span>
                </div>
                {% if selected_services %}
                <div class="summary-item">
                    <span>Tiền dịch vụ</span>
                    <span>{{ services_price|intcomma }} đ</span>
                </div>
                {% endif %}
            </div>
            <div class="summary-total">
                <span>TỔNG CỘNG</span>
                <span class="summary-grand-total">{{ total_price|intcomma }} đ</span>
            </div>
            
            <button type="submit" form="checkoutForm" class="btn-submit-booking">Hoàn tất Đặt phòng</button>
        </aside>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/booking-checkout.js' %}"></script>
{% endblock %}