{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Chi tiết Đơn hàng #{{ booking.id }} - Fivitel{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/booking.css' %}">
{% endblock %}

{% block content %}
<div class="container booking-detail-page">
    <a href="{% url 'my_bookings' %}" class="back-link"><i class="fas fa-arrow-left"></i> Quay lại danh sách đơn hàng</a>
    <h1 class="page-title" style="text-align: left; margin-bottom: 30px;">Chi tiết Đơn hàng #{{ booking.id }}</h1>

    <div class="detail-grid">
        <main class="main-content">
            
            <section class="detail-card">
                <h3>Hành trình Đơn hàng</h3>
                <ol class="status-timeline">
                    {% with current_status=booking.status %}
                    <li class="timeline-step {% if current_status == 'PENDING' or current_status == 'CONFIRMED' or current_status == 'CHECKED_IN' or current_status == 'COMPLETED' %}completed{% endif %} {% if current_status == 'PENDING' %}current{% endif %}">
                        <div class="step-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="step-label">Chờ xác nhận</div>
                    </li>
                    <li class="timeline-step {% if current_status == 'CONFIRMED' or current_status == 'CHECKED_IN' or current_status == 'COMPLETED' %}completed{% endif %} {% if current_status == 'CONFIRMED' %}current{% endif %}">
                        <div class="step-icon"><i class="fas fa-check"></i></div>
                        <div class="step-label">Đã xác nhận</div>
                    </li>
                    <li class="timeline-step {% if current_status == 'CHECKED_IN' or current_status == 'COMPLETED' %}completed{% endif %} {% if current_status == 'CHECKED_IN' %}current{% endif %}">
                        <div class="step-icon"><i class="fas fa-key"></i></div>
                        <div class="step-label">Đã nhận phòng</div>
                    </li>
                    <li class="timeline-step {% if current_status == 'COMPLETED' %}completed{% endif %}">
                        <div class="step-icon"><i class="fas fa-star"></i></div>
                        <div class="step-label">Hoàn thành</div>
                    </li>
                    {% endwith %}
                </ol>
            </section>

            <section class="detail-card">
                <h3>Chi tiết hành trình</h3>
                <div class="info-grid">
                    <div class="info-item"><strong>Ngày nhận phòng:</strong><span>{{ booking.check_in_date|date:"d/m/Y" }}</span></div>
                    <div class="info-item"><strong>Ngày trả phòng:</strong><span>{{ booking.check_out_date|date:"d/m/Y" }}</span></div>
                    <div class="info-item"><strong>Số đêm:</strong><span>{{ booking.duration }} đêm</span></div>
                    <div class="info-item"><strong>Số khách:</strong><span>{{ booking.adults }} người lớn, {{ booking.children }} trẻ em</span></div>
                </div>
            </section>
            
            <section class="detail-card">
                <h3>Thông tin khách hàng</h3>
                <div class="info-grid">
                    <div class="info-item"><strong>Họ tên:</strong><span>{{ booking.guest_full_name }}</span></div>
                    <div class="info-item"><strong>Email:</strong><span>{{ booking.guest_email }}</span></div>
                    <div class="info-item"><strong>Số điện thoại:</strong><span>{{ booking.guest_phone_number }}</span></div>
                </div>
            </section>
            
            {% if booking.additional_services.all %}
            <section class="detail-card">
                <h3>Dịch vụ đi kèm</h3>
                <ul class="amenities-list-detailed">
                    {% for service in booking.additional_services.all %}
                    <li><i class="fas fa-check-circle"></i> {{ service.name }}</li>
                    {% endfor %}
                </ul>
            </section>
            {% endif %}
        </main>

        <aside class="detail-sidebar">
            <div class="detail-card room-image-card">
                <h3>{{ booking.room_class.name }}</h3>
                <img src="{{ booking.room_class.image.url }}" alt="{{ booking.room_class.name }}">
            </div>

            <div class="detail-card">
                <h3>Tóm tắt thanh toán</h3>
                <div class="summary-details">
                    <div class="summary-item"><span>Phương thức:</span> <span>{{ booking.get_payment_method_display }}</span></div>
                    <div class="summary-item">
                        <span>Tiền phòng:</span> <span>{{ booking.room_price|intcomma }} VNĐ</span>                    
                    </div>
                    <div class="summary-item">
                        <span>Tiền dịch vụ:</span> <span>{{ booking.services_price|intcomma }} VNĐ</span>
                    </div>
                </div>
                <div class="summary-total">
                    <span>TỔNG CỘNG</span>
                    <span class="grand-total-price">{{ booking.total_price|intcomma }} đ</span>
                </div>
            </div>

            <div class="detail-card actions-card">
                <h3>Hành động</h3>
                <div class="action-list">
                    {% if booking.payment_method == 'BANK_TRANSFER' and booking.status == 'PENDING' %}
                        {% if booking.payment_proof and booking.payment_proof.image %}
                            <div class="payment-proof">
                                <img src="{{ booking.payment_proof.image.url }}" 
                                    alt="Bằng chứng thanh toán" 
                                    class="proof-thumbnail"
                                    onclick="openProofModal(this.src)">
                            </div>
                        {% else %}
                            <p class="text-muted">Chưa có bằng chứng thanh toán.</p>
                        {% endif %}
                        <a href="{% url 'payment_guidance' booking.pk %}" class="btn-upload-proof">
                            Tải lại bằng chứng thanh toán
                        </a>
                    {% endif %}

                    {% if booking.is_editable %}
                        <a href="{% url 'edit_booking' booking.pk %}" class="btn-secondary">
                            Chỉnh sửa Dịch vụ
                        </a>
                    {% endif %}

                    {% if booking.is_cancellable %}
                        <form action="{% url 'cancel_booking' booking.pk %}" method="post"
                            onsubmit="return confirm('Bạn có chắc chắn muốn hủy đơn hàng này không?');">
                            {% csrf_token %}
                            <button type="submit" class="btn-danger">Hủy đơn hàng</button>
                        </form>
                    {% endif %}
                </div>
            </div>

        </aside>
    </div>
</div>

<script>
function openProofModal(src) {
    // Tạo overlay modal
    const modal = document.createElement('div');
    modal.className = 'proof-modal';
    modal.innerHTML = `
        <span class="close-btn" onclick="closeProofModal()">&times;</span>
        <img src="${src}" alt="Proof Image">
    `;
    document.body.appendChild(modal);

    // Hiển thị modal với hiệu ứng fade
    setTimeout(() => modal.classList.add('show'), 10);

    // Đóng khi click ra ngoài ảnh
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeProofModal();
    });
}

function closeProofModal() {
    const modal = document.querySelector('.proof-modal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => modal.remove(), 300); // đợi animation kết thúc
    }
}
</script>

{% endblock %}